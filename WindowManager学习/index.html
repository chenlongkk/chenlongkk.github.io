<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个Android开发者的成长记录"><title>WindowManager学习 | chenlong's</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?c429fdd6ac00b6f7e59c44c7b27894b8";
var s = document.getElementsByTagName("script")[0]; 
s.parentNode.insertBefore(hm, s);
})();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">WindowManager学习</h1><a id="logo" href="/.">chenlong's</a><p class="description">Android开发技术博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 全部</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">WindowManager学习</h1><div class="post-meta">May 17, 2017<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><div class="post-content"><h1 id="一、Activity的视图层次"><a href="#一、Activity的视图层次" class="headerlink" title="一、Activity的视图层次"></a>一、Activity的视图层次</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">#Activity</div><div class="line">attch(....)&#123;</div><div class="line">  mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window);</div><div class="line">  mWindow.setWindowControllerCallback(<span class="keyword">this</span>);</div><div class="line">  mWindow.setCallback(<span class="keyword">this</span>);</div><div class="line">  mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</div><div class="line">  mWindow.getLayoutInflater().setPrivateFactory(<span class="keyword">this</span>);</div><div class="line">  </div><div class="line">  mWindow.setWindowManager(</div><div class="line">        (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</div><div class="line">        mToken, </div><div class="line">        mComponent.flattenToString(),</div><div class="line">        (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span></div><div class="line">      );</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 设置Activity的根视图</span></div><div class="line"><span class="comment"> * 几个重载形式</span></div><div class="line"><span class="comment"> * 1. setContentView(android.view.View)//此时，View本身的LayoutParams会被忽略，</span></div><div class="line"><span class="comment"> *    被覆盖为MATCH_PARENT</span></div><div class="line"><span class="comment"> * 2. setContentView(View view, ViewGroup.LayoutParams params)</span></div><div class="line"><span class="comment"> *    如果想在根视图上，使用自己的布局参数，可以使用这个方法。</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(@LayoutRes <span class="keyword">int</span> layoutResID)</span> </span>&#123;</div><div class="line">    getWindow().setContentView(layoutResID);</div><div class="line">    initWindowDecorActionBar();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际上是调用PhoneWindow的方法设置视图，我们来看看PhoneWindow的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</div><div class="line">  </div><div class="line">  <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">     <span class="comment">//创建DecorView</span></div><div class="line">     installDecor();</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">     mContentParent.removeAllViews();</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  ....</div><div class="line">  </div><div class="line">  <span class="comment">//向mContentParent中加入设置的视图</span></div><div class="line">  mLayoutInflater.inflate(layoutResID, mContentParent);</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="comment">//创建DecorView实例，实际上是一个FrameLayout</span></div><div class="line">    mDecor = generateDecor();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="comment">//根据定义的主题决定加载哪种布局</span></div><div class="line">    mContentParent = generateLayout(mDecor);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//设置根布局</span></div><div class="line"><span class="function">ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decorView)</span></span>&#123;</div><div class="line">  <span class="comment">//获取系统定义的属性，具体内容见下图</span></div><div class="line">  TypedArray a = getWindowStyle();</div><div class="line">  <span class="comment">//根据属性的实际值调用requestFeature和setFlags来设置窗体属性</span></div><div class="line">  ...</div><div class="line">  ...</div><div class="line">  <span class="comment">//根据feature不同，决定不同layout，例如通常情况下返回的带ActionBar的布局是</span></div><div class="line">  <span class="comment">//R.layout.screen_action_bar，内容如下图所示</span></div><div class="line">  <span class="keyword">int</span> layoutResource;</div><div class="line">  <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="number">0</span>) &#123;</div><div class="line">      layoutResource = R.layout.screen_swipe_dismiss;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_PROGRESS) | (<span class="number">1</span> &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != <span class="number">0</span></div><div class="line">                &amp;&amp; (features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) == <span class="number">0</span>) &#123;</div><div class="line">      layoutResource = R.layout.screen_progress;</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">  <span class="comment">//创建根布局View</span></div><div class="line">  View in = mLayoutInflater.inflate(layoutResource, <span class="keyword">null</span>);</div><div class="line">  decor.addView(in, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">  mContentRoot = (ViewGroup) in;</div><div class="line">  <span class="comment">//在布局中寻找com.android.internal.R.id.content对应的ViewGroup</span></div><div class="line">  ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</div><div class="line">  ...</div><div class="line">  <span class="comment">//返回给mContentParent</span></div><div class="line">  <span class="keyword">return</span> contentParent;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下图所示的是系统定义的Window属性，我们通常在主题中指定它们的值。<br><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fha9n28x1cj30v80pcai8.jpg" alt="Window属性"></p>
<p>下图是带ActionBar的根布局的布局文件，其中id为”@android:id/content”的FrameLayout是我们通过setContentView()设置的布局的父布局。<br><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fhaaa0o2lmj314l16dwse.jpg" alt="screen_action_bar.xml"></p>
<p>看到这里，我们大概知道了Activity的布局层次，如下图所示。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fhaanq5o9jj310s0v4mzs.jpg" alt=""></p>
<p>关于WindowManager，我们需要多说几句，这是一个接口，真正的实现类是WindowManagerImpl，那么这个WindowManagerImpl的实例是如何创建的呢？有两个地方创建这个WindowManager。<br>第一，在Activity的attach方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">attach(....)&#123;</div><div class="line">  ...</div><div class="line">  mWindow.setWindowManager(</div><div class="line">        <span class="comment">//注意,此处的context是ContextImpl的实例。</span></div><div class="line">        (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</div><div class="line">        mToken, </div><div class="line">        mComponent.flattenToString(),</div><div class="line">        (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span></div><div class="line">      );</div><div class="line">  ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ContextImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSystemService</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> SystemServiceRegistry.getSystemService(<span class="keyword">this</span>, name);</div><div class="line">&#125;</div><div class="line"><span class="comment">//SystemServiceRegistry.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getSystemService</span><span class="params">(ContextImpl ctx, String name)</span> </span>&#123;</div><div class="line">    ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</div><div class="line">    <span class="keyword">return</span> fetcher != <span class="keyword">null</span> ? fetcher.getService(ctx) : <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//SystemServiceRegistry在初始化的时候，会向SYSTEM_SERVICE_FETCHERS中注册一些Fetcher，对于WINDOW_SERVICE的fetcher如下。</span></div><div class="line">registerService(Context.WINDOW_SERVICE, WindowManager.class,</div><div class="line">    <span class="keyword">new</span> CachedServiceFetcher&lt;WindowManager&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> WindowManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">            <span class="comment">//重点关注一下这里，此处创建了WindowManagerImpl的实例。</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WindowManagerImpl(ctx.getDisplay());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">//接下来向PhoneWindow中赋值WindowManagerImpl。</span></div><div class="line"></div><div class="line"><span class="comment">//Window.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowManager</span><span class="params">(WindowManager wm, IBinder appToken, String appName,</span></span></div><div class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> hardwareAccelerated)</span> </span>&#123;</div><div class="line">    mAppToken = appToken;</div><div class="line">    mAppName = appName;</div><div class="line">    mHardwareAccelerated = hardwareAccelerated</div><div class="line">                || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, <span class="keyword">false</span>);</div><div class="line">    <span class="keyword">if</span> (wm == <span class="keyword">null</span>) &#123;</div><div class="line">      wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//重点关注这里，并没有直接赋值WindowManagerImpl，而是调用createLocalWindowMan//ager创建了一个新的实例。</span></div><div class="line">    mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">//WindowManagerImpl.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> WindowManagerImpl <span class="title">createLocalWindowManager</span><span class="params">(Window parentWindow)</span> </span>&#123;</div><div class="line">    <span class="comment">//创建了一个包含parentWindow的WindowManagerImpl</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WindowManagerImpl(mDisplay, parentWindow);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//我们再次回到Activity的attach方法中.</span></div><div class="line">attach(...)&#123;</div><div class="line">  ...</div><div class="line">  <span class="comment">//为Activity赋值mWindowManager</span></div><div class="line">  mWindowManager = mWindow.getWindowManager();</div><div class="line">  ...</div><div class="line">&#125;</div><div class="line"><span class="comment">//至此，我们创建了一个WindowManagerImpl的实例，并且它的mParentWindow就是当前Activity的PhoneWindow实例，同时我们将这个实例赋值给了mWindowManager变量，后续我们在Activity中通过getSystemService获取的WindowManager都是这个实例。</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSystemService</span><span class="params">(@ServiceName @NonNull String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (WINDOW_SERVICE.equals(name)) &#123;</div><div class="line">        <span class="keyword">return</span> mWindowManager;</div><div class="line">    &#125;</div><div class="line">    ....</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.getSystemService(name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是，我们还是有很多的疑惑，我们将视图设置到DecorView之后，系统是如何展示出来的呢？视图的三大方法measure,layout,draw是在何时调用的呢？要深究这些问题，我们就得再回过头来看看Activity的启动流程了。</p>
<h1 id="二、Activity启动流程与WindowManagerService"><a href="#二、Activity启动流程与WindowManagerService" class="headerlink" title="二、Activity启动流程与WindowManagerService"></a>二、Activity启动流程与WindowManagerService</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">-&gt;ActivityThread.handleLaunchActivity()</div><div class="line">  -&gt;performLaunchActivity</div><div class="line">    -&gt;<span class="comment">//1. attch方法中回调onContextAttach()</span></div><div class="line">    -&gt;<span class="comment">//2. onCreate</span></div><div class="line">  -&gt;handleResumeActivity</div><div class="line">    -&gt;r.activity.performResume();</div><div class="line">      -&gt;<span class="number">1</span>. onRestart</div><div class="line">      -&gt;<span class="number">2</span>. onStart</div><div class="line">      -&gt;<span class="number">3</span>. onResume</div><div class="line">      </div><div class="line">      ---------&gt;<span class="comment">//添加向WindowManager中添加View</span></div><div class="line">                <span class="comment">//在Activity的attach方法中，我们创建了PhoneWindow</span></div><div class="line">                r.window = r.activity.getWindow();</div><div class="line">                <span class="comment">//Activity的onCreate方法中，我们调用setContentView(xxxx)，触发了PhoneWindow创建</span></div><div class="line">                <span class="comment">//DecorView的过程，如果之前我们没有调用setContentView，那么此时getDecorView时也会</span></div><div class="line">                <span class="comment">//触发创建</span></div><div class="line">                View decor = r.window.getDecorView();</div><div class="line">                <span class="comment">//decor首先不可见，先添加到Window后再展示出来</span></div><div class="line">                decor.setVisibility(View.INVISIBLE);</div><div class="line">                <span class="comment">//在Activity的attach方法中，通过getSystemService获取了WmS</span></div><div class="line">                ViewManager wm = a.getWindowManager();</div><div class="line">                <span class="comment">//获取Phonewindow的LayoutParams，此处获取的就是默认的LayoutParams</span></div><div class="line">                <span class="comment">//type为TYPE_APPLICATION，长宽均为MATCH_PARENT</span></div><div class="line">                WindowManager.LayoutParams l = r.window.getAttributes();</div><div class="line">                <span class="comment">//赋值mDecor</span></div><div class="line">                a.mDecor = decor;</div><div class="line">                <span class="comment">//更改Window的Type</span></div><div class="line">                l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</div><div class="line">                l.softInputMode |= forwardBit;</div><div class="line">                <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</div><div class="line">                    <span class="comment">//向WindowManager添加View</span></div><div class="line">                    a.mWindowAdded = <span class="keyword">true</span>;</div><div class="line">                    wm.addView(decor, l);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//展示DecorView</span></div><div class="line">                r.activity.makeVisible();</div><div class="line">                <span class="comment">//通知AmS，当前Activity的Resume生命周期执行完毕。</span></div><div class="line">                ActivityManagerNative.getDefault().activityResumed(token);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line">  <span class="comment">//1. attch方法中回调onContextAttach()</span></div><div class="line">  activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</div><div class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                        r.referrer, r.voiceInteractor);</div><div class="line">  <span class="comment">//2. onCreate</span></div><div class="line">  mInstrumentation.callActivityOnCreate(activity, r.state);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>执行顺序是AmS回调ActivityThread的scheduleLaunchActivity，然后在handleLaunchActivity中执行performLaunchActivity，performLaunchActivity中创建Activity的实例并attach，在这个过程中创建了PhoneWindow和DecorView以及其它视图，但是并没有添加到WindowManager中。接着调用handleResumeActivity，回调了onStart和onResume方法，并将decorView添加到WindowManager，最后调用Ams的activityResumed方法通知AmS当前Activity已经处在resume的状态。</p>
<p>接下来我们重点看一下WindowManager的addView和makeVisible方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//1. 从Window中获取的WindowManager是WindowManagerImpl的实例</span></div><div class="line"><span class="comment">//2. WindowManagerImpl只是代理类，最终的调用时通过WindowManagerGlobal调用的。</span></div><div class="line"><span class="comment">//3. WindowManagerGlobal是一个单例，它的初始化是在ActivityThread中第一次LaunchActivity时，通过WindowManagerGlobal.initialize()，初始化了sWindowManagerService变量。</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * view:待添加的View</span></div><div class="line"><span class="comment"> * params: </span></div><div class="line"><span class="comment"> * display:各种屏幕信息，例如屏幕大小，密度等</span></div><div class="line"><span class="comment"> * parentWindow: 如果当前窗口是子窗口，则为父窗口，否则为空</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></div><div class="line"><span class="function"><span class="params">            Display display, Window parentWindow)</span> </span>&#123;</div><div class="line">    <span class="comment">//当前窗口的ViewRoot</span></div><div class="line">    ViewRootImpl root;</div><div class="line">    </div><div class="line">    <span class="comment">//传入的window参数</span></div><div class="line">    <span class="keyword">final</span> WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</div><div class="line">    <span class="comment">//如果父窗口不为空，那么先让子窗口适应父窗口的参数，重点关注一下这里。</span></div><div class="line">    <span class="comment">//在Activity创建的时候，我们创建了一个PhoneWindow，并且创建了一个WindowManagerImpl实例，这个WindowManagerImpl的父窗口就是Activity的PhoneWindow，因此</span></div><div class="line">    <span class="comment">//此处需要先修改一下参数。</span></div><div class="line">    <span class="comment">//虽然感觉有些奇怪，毕竟当前窗口的父窗口是它自己...</span></div><div class="line">    <span class="keyword">if</span> (parentWindow != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//这里最重要的修改就是设置params的token。</span></div><div class="line">        <span class="comment">//在Activity启动的时候，这里的token被设置为AmS返回的正在启动Activity的ActivityRecorder的IBinder实例。</span></div><div class="line">        parentWindow.adjustLayoutParamsForSubWindow(wparams);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// If there's no parent, then hardware acceleration for this view is</span></div><div class="line">      <span class="comment">// set from the application's hardware acceleration setting.</span></div><div class="line">      <span class="keyword">final</span> Context context = view.getContext();</div><div class="line">      <span class="keyword">if</span> (context != <span class="keyword">null</span> &amp;&amp; (context.getApplicationInfo().flags</div><div class="line">                          &amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>) &#123;</div><div class="line">          wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//如果当前窗口是子窗口，则为父窗口的View</span></div><div class="line">    View panelParentView = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</div><div class="line">        wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) &#123;</div><div class="line">          <span class="keyword">final</span> <span class="keyword">int</span> count = mViews.size();</div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (mRoots.get(i).mWindow.asBinder() == wparams.token) &#123;</div><div class="line">              panelParentView = mViews.get(i);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//创建当前窗口的ViewRoot</span></div><div class="line">    root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</div><div class="line">    <span class="comment">//设置布局参数</span></div><div class="line">    view.setLayoutParams(wparams);</div><div class="line">    </div><div class="line">    <span class="comment">//将view，viewroot，wparams添加到全局的三个数组中进行管理。</span></div><div class="line">    mViews.add(view);</div><div class="line">    mRoots.add(root);</div><div class="line">    mParams.add(wparams);</div><div class="line">    </div><div class="line">    <span class="comment">//开始加载视图，这个方法很长，我们待会再看...</span></div><div class="line">    root.setView(view, wparams, panelParentView);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Window.java</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">adjustLayoutParamsForSubWindow</span><span class="params">(WindowManager.LayoutParams wp)</span> </span>&#123;</div><div class="line">    CharSequence curTitle = wp.getTitle();</div><div class="line">    <span class="comment">//如果是子窗口</span></div><div class="line">    <span class="keyword">if</span> (wp.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</div><div class="line">        wp.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) &#123;</div><div class="line">          <span class="keyword">if</span> (wp.token == <span class="keyword">null</span>) &#123;</div><div class="line">              View decor = peekDecorView();</div><div class="line">              <span class="keyword">if</span> (decor != <span class="keyword">null</span>) &#123;</div><div class="line">                  wp.token = decor.getWindowToken();</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          </div><div class="line">          <span class="keyword">if</span> (curTitle == <span class="keyword">null</span> || curTitle.length() == <span class="number">0</span>) &#123;</div><div class="line">                ...<span class="comment">//根据type设置title</span></div><div class="line">                wp.setTitle(title);</div><div class="line">          &#125;</div><div class="line">        </div><div class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">//其他类型的窗口</span></div><div class="line">        <span class="comment">//使用当前窗口的token</span></div><div class="line">        <span class="keyword">if</span> (wp.token == <span class="keyword">null</span>) &#123;</div><div class="line">            wp.token = mContainer == <span class="keyword">null</span> ? mAppToken : mContainer.mAppToken;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> ((curTitle == <span class="keyword">null</span> || curTitle.length() == <span class="number">0</span>)&amp;&amp; mAppName != <span class="keyword">null</span>) &#123;</div><div class="line">            wp.setTitle(mAppName);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (wp.packageName == <span class="keyword">null</span>) &#123;</div><div class="line">            wp.packageName = mContext.getPackageName();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (mHardwareAccelerated) &#123;</div><div class="line">            wp.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，我们看完了Activity启动的时候创建Window的全部过程，在这个过程我们重点关注两个变量，一个是Window的token和window的type。</p>
<p>Window的Type有三种，系统窗口，应用窗口，子窗口，每一种类型的窗口对应一个type范围。</p>
<h3 id="Application-windows-应用窗口"><a href="#Application-windows-应用窗口" class="headerlink" title="Application windows 应用窗口"></a>Application windows 应用窗口</h3><p>type范围：FIRST_APPLICATION_WINDOW~LAST_APPLICATION_WINDOW = [1,99]</p>
<ol>
<li>TYPE_BASE_APPLICATION:应用的基础窗口，所有其他的应用窗口都在它之上展示。Activity的窗口类型。</li>
<li>TYPE_APPLICATION:普通的应用窗口，窗口的token必须是Activity的token，标识这个窗口属于哪个窗口。Dialog的窗口类型。</li>
<li>TYPE_APPLICATION_STARTING:在应用启动之前展示的窗口类型，也就是通常我们会遇到的，应用启动时白屏、黑屏对应的窗口，这个窗口并不是由应用自己展示的，而是由系统根据我们的配置在应用启动的时候展示。</li>
</ol>
<h3 id="Sub-windows-子窗口"><a href="#Sub-windows-子窗口" class="headerlink" title="Sub-windows 子窗口"></a>Sub-windows 子窗口</h3><p>type范围：FIRST_SUB_WINDOW~LAST_SUB_WINDOW = [1000,1999]<br>e.g.<br>TYPE_APPLICATION_PANEL: 应用的子窗口，PopupWindow的类型。<br>TYPE_APPLICATION_ATTACHED_DIALOG: ContextMenu的窗口类型。</p>
<h3 id="System-windows-系统窗口"><a href="#System-windows-系统窗口" class="headerlink" title="System windows 系统窗口"></a>System windows 系统窗口</h3><p>type范围：FIRST_SYSTEM_WINDOW~LAST_SYSTEM_WINDOW = [2000~2999]<br>e.g.<br>TYPE_TOAST:Toast的窗口类型<br>窗口的type对应了窗口的层值，WmS在管理这些窗口的时候，会根据窗口的层值进行排序，层值越高的窗口排列在最上面。</p>
<p>Window的token</p>
<ol>
<li>系统窗口不需要token</li>
<li>对于应用窗口,Activity的窗口的token是当前Activity或者TabActivity的ActivityRecord</li>
<li>PopupWindow的token是anchor View的token，也就是View所在Window的W类。</li>
<li>Dialog的token是当前Activity的ActivityRecord</li>
</ol>
</div><div class="tags"></div><div class="post-nav"><a href="/ReactNative-应用启动过程/" class="pre">ReactNative-应用启动过程</a><a href="/Retrofit源码阅读/" class="next">Retrofit源码阅读</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/">Gradle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ReactNative/">ReactNative</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作/">工作</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/插件化/">插件化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机/">计算机</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">chenlong's.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>