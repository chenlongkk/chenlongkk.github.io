<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个Android开发者的成长记录"><title>AndroidGradlePlugin源码阅读-导入源码 | chenlong's</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?c429fdd6ac00b6f7e59c44c7b27894b8";
var s = document.getElementsByTagName("script")[0]; 
s.parentNode.insertBefore(hm, s);
})();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">AndroidGradlePlugin源码阅读-导入源码</h1><a id="logo" href="/.">chenlong's</a><p class="description">Android开发技术博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 全部</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">AndroidGradlePlugin源码阅读-导入源码</h1><div class="post-meta">Mar 12, 2017<span> | </span><span class="category"><a href="/categories/Gradle/">Gradle</a></span></div><div class="post-content"><h2 id="一、准备工作"><a href="#一、准备工作" class="headerlink" title="一、准备工作"></a>一、准备工作</h2><h3 id="0x00-导入源码"><a href="#0x00-导入源码" class="headerlink" title="0x00 导入源码"></a>0x00 导入源码</h3><p>参考官方教程，将aosp的源码同步下来，切换到<code>gradle_2.3.0</code>tag，准备完毕后目录结构如下：</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009d2" alt="gradle_2.3.0"></p>
<p>如果之前有设置过<code>$OUT_DIR</code>变量，为了避免错误，可以先关掉这个变量，这样默认的<code>out</code>目录是在当前目录。</p>
<p>我们要分析的代码在<code>tools/base</code>目录下，使用idea打开<code>tools/base</code>，注意checkout出来的源码目录自带了.idea目录，因此可以直接打开。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009d0" alt="idea"></p>
<p>打开之后的工程结构如上图所示。</p>
<p>使用命令行进入<code>tools</code>目录，执行<code>./gradlew clean assemble</code>，开始编译。</p>
<p><strong>错误处理 1：</strong></p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">:clean FAILED</div><div class="line"></div><div class="line"><span class="keyword">FAILURE: </span>Build failed with an exception.</div><div class="line"></div><div class="line">* Where:</div><div class="line">Build file '/Users/chenlong/tools_gradle_2_3_0/tools/build.gradle' line: 115</div></pre></td></tr></table></figure>
<p><strong>解决方案：</strong><br>修改<code>tools/build.gradle</code>的<code>task clean</code>如下：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> clean &lt;&lt; &#123;</div><div class="line">    <span class="keyword">delete</span> <span class="string">'build'</span></div><div class="line">    <span class="keyword">File</span> <span class="keyword">file</span> = <span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">"$localRepo/com/android/tools"</span>)</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">file</span>.exist())&#123;</div><div class="line">        <span class="keyword">file</span>.<span class="keyword">eachFile</span> &#123;</div><div class="line">            <span class="keyword">if</span>(it.name != <span class="string">'extrnal'</span>) <span class="keyword">delete</span> it</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>错误处理2：</strong><br><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">/Users/chenlong/tools_gradle_2_3_0/tools/<span class="keyword">base</span>/build-system/gradle-experimental/src/main/java/com/android/build/gradle/<span class="keyword">internal</span>/dependency/NativeDependencyResolver.java:<span class="number">122</span>: error: cannot find symbol</div><div class="line">            NamedDomainObjectSet&lt;PrebuiltLibraries&gt; repositories, String libraryName) &#123;</div><div class="line">            ^</div><div class="line">  symbol:   <span class="keyword">class</span> NamedDomainObjectSet</div><div class="line">  location: <span class="keyword">class</span> NativeDependencyResolver</div><div class="line">Note: Some input files <span class="keyword">use</span> <span class="keyword">or</span> <span class="keyword">override</span> a deprecated API.</div><div class="line">Note: Recompile <span class="keyword">with</span> -Xlint:deprecation <span class="keyword">for</span> details.</div><div class="line">Note: Some input files <span class="keyword">use</span> unchecked <span class="keyword">or</span> unsafe operations.</div><div class="line">Note: Recompile <span class="keyword">with</span> -Xlint:unchecked <span class="keyword">for</span> details.</div><div class="line">Note: Some messages have been simplified; recompile <span class="keyword">with</span> -Xdiags:verbose <span class="keyword">to</span> get full output</div><div class="line"><span class="number">100</span> errors</div><div class="line">:<span class="keyword">base</span>:gradle-experimental:compileJava FAILED</div><div class="line"></div><div class="line">FAILURE: Build failed <span class="keyword">with</span> an <span class="keyword">exception</span>.</div><div class="line"></div><div class="line">* What went wrong:</div><div class="line">Execution failed <span class="keyword">for</span> task ':<span class="keyword">base</span>:gradle-experimental:compileJava'.</div></pre></td></tr></table></figure></p>
<p><strong>解决方案</strong><br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">执行</div><div class="line"> ./gradlew extractGradleLibs</div><div class="line"> 作用是将<span class="keyword">external</span>/gradle/gradle-<span class="number">3.3</span>-bin.zip解压到<span class="keyword">out</span>/alternate-gradle/gradle-<span class="number">3.3</span>目录下，用于编译时依赖。</div></pre></td></tr></table></figure></p>
<h3 id="0x01-编译与调试"><a href="#0x01-编译与调试" class="headerlink" title="0x01 编译与调试"></a>0x01 编译与调试</h3><p>接下来，我们需要编译出自己的plugin，然后进行debug。2.3.0版本的plugin使用gradle3.3进行编译，为了方便，我们直接使用./gradlew就好，它会从<code>external</code>解压出gradle3.3来进行编译，而不是通常的从官网下载。</p>
<p>执行<code>./gradlew clean assemble publish publishToMavenLocal</code></p>
<p>如果一切顺利的话，编译完成的plugin被发布到本地的maven仓库，地址为<code>$HOME/.m2/repository</code>。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009d4" alt="编译后"></p>
<p>如果想改一下版本名字用来和官方发布的版本做区分的话，可以修改<code>tools/buildSrc/base/version.properties</code>中的<code>buildVersion</code>字段。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009d6" alt=""></p>
<p>需要注意，使用非官方版本的gradle plugin，Android Studio会报错，但是是可以正常编译的。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009cd" alt="AS报错"></p>
<p>接下来，我们新建一个Android工程<code>GradleDebug</code>，使用我们刚刚编译好的插件，工程根目录的build.gradle如下</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        <span class="comment">//一定要把mavenLocal写在最前面</span></div><div class="line">        mavenLocal()</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        <span class="comment">//我们刚刚编译的plugin，2.3.0版本</span></div><div class="line">        classpath <span class="string">'com.android.tools.build:gradle:2.3.0'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来，我们使用idea来debug刚刚新建的工程的构建过程，首先新增一个Remote运行选项，如下图，进入Edit Configuration。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009cc" alt=""></p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009d1" alt=""></p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009cf" alt=""></p>
<p>使用命令行进入<code>GradleDebug</code>，执行<code>gradle --no-daemon -Dorg.gradle.debug=true assemble</code>，开启gradle的调试模式。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009d3" alt=""></p>
<p>在调试模式下，gradle会在启动后暂停，等待调试器连接，这个时候，我们就可以在idea上打上断点，然后连接上这个进程，如下图所示。</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009d5" alt=""></p>
<p><img src="https://leanote.com/api/file/getImage?fileId=597ab67aab64410fae0009ce" alt=""></p>
</div><div class="tags"></div><div class="post-nav"><a href="/泛型与反射学习笔记/" class="pre">泛型与反射学习笔记</a><a href="/InstantRun源码阅读笔记/" class="next">InstantRun源码阅读笔记</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/">Gradle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ReactNative/">ReactNative</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作/">工作</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/插件化/">插件化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机/">计算机</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">chenlong's.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>