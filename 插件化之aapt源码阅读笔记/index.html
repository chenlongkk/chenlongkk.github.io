<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个Android开发者的成长记录"><title>插件化之aapt源码阅读笔记 | chenlong's</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?c429fdd6ac00b6f7e59c44c7b27894b8";
var s = document.getElementsByTagName("script")[0]; 
s.parentNode.insertBefore(hm, s);
})();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">插件化之aapt源码阅读笔记</h1><a id="logo" href="/.">chenlong's</a><p class="description">Android开发技术博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 全部</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">插件化之aapt源码阅读笔记</h1><div class="post-meta">Sep 1, 2016<span> | </span><span class="category"><a href="/categories/插件化/">插件化</a></span></div><div class="post-content"><h3 id="0x00-工程结构"><a href="#0x00-工程结构" class="headerlink" title="0x00 工程结构"></a>0x00 工程结构</h3><p>这次阅读的是aosp项目中android-6.0.1_r66的代码。<br>git地址:<a href="https://android.googlesource.com/platform/frameworks/base/+/android-6.0.1_r66" target="_blank" rel="external">https://android.googlesource.com/platform/frameworks/base/+/android-6.0.1_r66</a><br>aapt的代码位于/platform/frameworks/base/tools/aapt目录，推荐使用CLion导入aapt的代码，虽然无法编译，但是CLion提供了非常方便的索引功能，能够方便的在各个代码文件中跳转。我试过使用vscode，sublime，vim+ctag等工具，不得不承认，idea系列的IDE真的很方便，虽然贵点。</p>
<p>为了更好的理解aapt的代码，我准备了一个Hello World工程，它的资源目录是这样的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">res</div><div class="line">├── color</div><div class="line">│   └── chat_color_selector.xml</div><div class="line">├── drawable</div><div class="line">│   ├── ic_chat.xml</div><div class="line">│   └── ic_tab_chat.xml</div><div class="line">├── layout</div><div class="line">│   ├── item_layout.xml</div><div class="line">│   ├── list_layout.xml</div><div class="line">│   ├── sublayout</div><div class="line">│   │   └── main_layout.xml</div><div class="line">│   └── tint_activity.xml</div><div class="line">├── layout-small-land-hdpi-v21</div><div class="line">│   ├── item_layout.xml</div><div class="line">│   ├── list_layout.xml</div><div class="line">│   ├── sublayout</div><div class="line">│   │   └── main_layout.xml</div><div class="line">│   └── tint_activity.xml</div><div class="line">├── mipmap-hdpi</div><div class="line">│   └── ic_launcher.png</div><div class="line">├── mipmap-mdpi</div><div class="line">│   └── ic_launcher.png</div><div class="line">├── mipmap-xhdpi</div><div class="line">│   └── ic_launcher.png</div><div class="line">├── mipmap-xxhdpi</div><div class="line">│   └── ic_launcher.png</div><div class="line">├── mipmap-xxxhdpi</div><div class="line">│   └── ic_launcher.png</div><div class="line">├── raw</div><div class="line">│   └── bundle.json</div><div class="line">└── values</div><div class="line">    ├── colors.xml</div><div class="line">    ├── strings.xml</div><div class="line">    └── styles.xml</div></pre></td></tr></table></figure>
<h3 id="0x01-从Main函数开始"><a href="#0x01-从Main函数开始" class="headerlink" title="0x01 从Main函数开始"></a>0x01 从Main函数开始</h3><p>我们知道，一个程序的开始，总是main函数，因此我们从aapt的main函数开始。main函数位于Main.cpp中，这个函数很长，但是逻辑很简单，只做了两件事：</p>
<ol>
<li>解析命令行参数</li>
<li>执行解析后的命令</li>
</ol>
<p>使用aapt时，我们是通过aapt COMMAND OPTIONS 这种形式传入参数的，因此解析参数也分为两部分，解析COMMAND，解析OPTIONS。</p>
<p>读取COMMAND:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'v'</span>)</div><div class="line">        bundle.setCommand(kCommandVersion);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'d'</span>)</div><div class="line">        bundle.setCommand(kCommandDump);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'l'</span>)</div><div class="line">        bundle.setCommand(kCommandList);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'a'</span>)</div><div class="line">        bundle.setCommand(kCommandAdd);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'r'</span>)</div><div class="line">        bundle.setCommand(kCommandRemove);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'p'</span>)</div><div class="line">        bundle.setCommand(kCommandPackage);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'c'</span>)</div><div class="line">        bundle.setCommand(kCommandCrunch);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'s'</span>)</div><div class="line">        bundle.setCommand(kCommandSingleCrunch);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'m'</span>)</div><div class="line">        bundle.setCommand(kCommandDaemon);</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"ERROR: Unknown command '%s'\n"</span>, argv[<span class="number">1</span>]);</div><div class="line">        wantUsage = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">goto</span> bail;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>aapt有9个COMMAND命令，具体含义可以参考帮助，这里我们暂时只关注<code>p</code>命令，也就是打包命令。</p>
<p>注意到，解析参数之前，aapt创建了一个Bundle对象，来保存命令行参数，后面我们会看到在打包过程，我们会需要从Bundle中读取参数信息。</p>
<p>接下来是一堆解析OPTIONS的代码，全部看一遍不太现实，先找我们需要的看。如果我们要针对HelloWorld工程的资源，生成R.java文件，通常会这样使用aapt:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">aapt package \   <span class="comment">#打包资源文件</span></div><div class="line">-f           \   <span class="comment">#强制覆盖已有文件</span></div><div class="line">-m           \   <span class="comment">#使R文件在-J参数指定的位置生成</span></div><div class="line">-S res       \   <span class="comment">#资源目录</span></div><div class="line">-J gen       \   <span class="comment">#R.java的位置</span></div><div class="line">-I <span class="variable">$ANDROID_HOME</span>/platforms/android-23/android.jar \ <span class="comment">#base-package</span></div><div class="line">-M AndroidManifest.xml                              <span class="comment">#清单文件的路径</span></div></pre></td></tr></table></figure>
<p>针对这次编译，我们会依次执行下列代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span>&#123;</div><div class="line">  ...</div><div class="line">  <span class="comment">//设置apk的压缩算法，默认是用DEFLATE算法。</span></div><div class="line">  <span class="comment">//可以通过-0 参数指定某一后缀的文件不进行压缩，或者所有文件都不进行压缩</span></div><div class="line">  bundle.setCompressionMethod(ZipEntry::kCompressDeflated);</div><div class="line">  <span class="comment">//...</span></div><div class="line">  <span class="comment">//将要执行的命令是package</span></div><div class="line">  bundle.setCommand(kCommandPackage);</div><div class="line">  <span class="comment">//...</span></div><div class="line">  <span class="comment">//解析-f 参数，强制覆盖已经存在的文件</span></div><div class="line">  bundle.setForce(<span class="literal">true</span>);</div><div class="line">  <span class="comment">//...</span></div><div class="line">  <span class="comment">//解析-m 参数，让R.java文件在-J参数指定的路径生成</span></div><div class="line">  bundle.setMakePackageDirs(<span class="literal">true</span>);</div><div class="line">  <span class="comment">//...</span></div><div class="line">  <span class="comment">//解析-R 参数，设置R.java文件生成的路径</span></div><div class="line">  convertPath(argv[<span class="number">0</span>]);</div><div class="line">  bundle.setRClassDir(argv[<span class="number">0</span>]);</div><div class="line">  <span class="comment">//...</span></div><div class="line">  <span class="comment">//解析-S 参数，设置资源文件的路径</span></div><div class="line">  convertPath(argv[<span class="number">0</span>]);</div><div class="line">  bundle.addResourceSourceDir(argv[<span class="number">0</span>]);</div><div class="line">  <span class="comment">//...</span></div><div class="line">  <span class="comment">//解析-I 参数，设置base res的目录</span></div><div class="line">  convertPath(argv[<span class="number">0</span>]);</div><div class="line">  bundle.addPackageInclude(argv[<span class="number">0</span>]);</div><div class="line">  <span class="comment">//...</span></div><div class="line">  <span class="comment">//解析-M 参数，设置AndroidManifest.xml的路径</span></div><div class="line">  convertPath(argv[<span class="number">0</span>]);</div><div class="line">  bundle.setAndroidManifestFile(argv[<span class="number">0</span>]);</div><div class="line">  <span class="comment">//...</span></div><div class="line">  <span class="comment">//解析命令行中剩下的文件路径，一般写在最后，这些资源都会被作为raw类型的资源打包进apk中</span></div><div class="line">  bundle.setFileSpec(argv, argc);</div><div class="line">  </div><div class="line">  <span class="comment">//执行命令</span></div><div class="line">  result = handleCommand(&amp;bundle);</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>解析完所有的参数后，就会通过handleCommand函数，进入到命令执行阶段。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Dispatch the command.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">handleCommand</span><span class="params">(Bundle* bundle)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">switch</span> (bundle-&gt;getCommand()) &#123;</div><div class="line">    <span class="keyword">case</span> kCommandVersion:      <span class="keyword">return</span> doVersion(bundle);</div><div class="line">    <span class="keyword">case</span> kCommandList:         <span class="keyword">return</span> doList(bundle);</div><div class="line">    <span class="keyword">case</span> kCommandDump:         <span class="keyword">return</span> doDump(bundle);</div><div class="line">    <span class="keyword">case</span> kCommandAdd:          <span class="keyword">return</span> doAdd(bundle);</div><div class="line">    <span class="keyword">case</span> kCommandRemove:       <span class="keyword">return</span> doRemove(bundle);</div><div class="line">    <span class="keyword">case</span> kCommandPackage:      <span class="keyword">return</span> doPackage(bundle);<span class="comment">//打包命令执行的函数</span></div><div class="line">    <span class="keyword">case</span> kCommandCrunch:       <span class="keyword">return</span> doCrunch(bundle);</div><div class="line">    <span class="keyword">case</span> kCommandSingleCrunch: <span class="keyword">return</span> doSingleCrunch(bundle);</div><div class="line">    <span class="keyword">case</span> kCommandDaemon:       <span class="keyword">return</span> runInDaemonMode(bundle);</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s: requested command not yet supported\n"</span>, gProgName);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="0x02-执行命令"><a href="#0x02-执行命令" class="headerlink" title="0x02 执行命令"></a>0x02 执行命令</h3><p>解析参数完成后，接下来会走到<code>doPackage</code>函数，这个函数有两种使用场景，一种是编译资源id，也就是产生R.java文件，另一种是生成apk文件。目前，我们只看编译资源id的第一步，也就是收集资源的过程。<br>这一步，在doPackage函数中只有两行语句。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//...</span></div><div class="line"><span class="comment">//创建AaptAssets对象</span></div><div class="line">assets = <span class="keyword">new</span> AaptAssets();</div><div class="line"><span class="comment">//...</span></div><div class="line"><span class="comment">//收集资源</span></div><div class="line">err = assets-&gt;slurpFromArgs(bundle);</div></pre></td></tr></table></figure>
<p>我们首先看一下和AaptAssets相关的几个类，它们之间的关系如下。</p>
<p><img src="http://ww4.sinaimg.cn/large/7853084cjw1f7xqo3k5yqj21520x5tfi.jpg" alt="aapt-UML"></p>
<p>解释一下这几个类的作用：</p>
<ol>
<li>AaptAssets 描述了一个res/文件夹。在使用aapt时，通过-S参数可以指定多个res/文件夹，例如，在使用support-v7包时，我们就需要将v7包中的资源打包进我们自己的工程中。</li>
<li>AaptDir 描述了一个资源文件夹，这里的资源文件夹不仅指的是res/下的layout/，values/文件夹，同时也包括layout/下的子文件夹，assets/目录下的子文件等，从继承关系上，我们也能看出，AaptAssets继承自AaptDir，因为res/文件夹也是一个文件夹，很合理。</li>
<li>AaptGroup 描述了一个资源集合。我们知道，为了适配多种屏幕，资源文件可以根据不同的设备类型进行区分，通过建立类似layout-xhdpi/、layout-xxhdpi/的文件夹来存放同一个资源的多个副本。AaptGroup这个类描述的就是同一个资源的多个副本。</li>
<li>AaptFile 描述了一个资源文件，这个没有什么好说的，就是对资源文件的抽象</li>
<li>AaptGroupEntry 描述了资源的配置信息。在针对多种设备进行适配时，Android系统提供了多达十八个维度的描述信息，AaptGroupEntry是对这些描述信息的抽象，通过UML图，我们可以看到，真正用来描述这些信息的是<code>ResTable_config</code>，这些描述信息不仅在编译时使用，在运行时，Android系统也会通过这些描述信息，为设备选取最合适的资源副本。</li>
</ol>
<p>下面我们根据HelloWorld的编译过程，一步一步的看<code>slurpFromArgs(Bundle *bundle)</code>函数的执行过程。</p>
<p><em>Step 1 收集AndroidManifest.xml文件</em> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (bundle-&gt;getAndroidManifestFile() != <span class="literal">NULL</span>) &#123;</div><div class="line">       String8 srcFile(bundle-&gt;getAndroidManifestFile());</div><div class="line">       </div><div class="line">       <span class="comment">/**********************************/</span></div><div class="line">       addFile(srcFile.getPathLeaf(),<span class="comment">//获取文件名，</span></div><div class="line">               AaptGroupEntry(),     <span class="comment">//创建AaptGroupEntry对象</span></div><div class="line">               srcFile.getPathDir(), <span class="comment">//获取文件所在文件夹名称</span></div><div class="line">               <span class="literal">NULL</span>,                 <span class="comment">//sp&lt;AaptGroup&gt; outGroup</span></div><div class="line">               String8()             <span class="comment">//resTyp</span></div><div class="line">               );</div><div class="line">       <span class="comment">/**********************************/</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><em>Step 2 收集assets资源</em> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Vector&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;&amp; assetDirs </div><div class="line">                            = bundle-&gt;getAssetSourceDirs();</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> AN = assetDirs.size();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; AN; i++) &#123;</div><div class="line">    <span class="function">String8 <span class="title">assetRoot</span><span class="params">(assetDirs[i])</span></span>;</div><div class="line">    <span class="comment">//对raw类型的资源,没有资源的配置信息,并且路径为assets</span></div><div class="line">    sp&lt;AaptDir&gt; assetAaptDir = makeDir(String8(kAssetDir));</div><div class="line">    AaptGroupEntry group;</div><div class="line">    </div><div class="line">    <span class="comment">/**********************************/</span></div><div class="line">    count = assetAaptDir-&gt;slurpFullTree(bundle, </div><div class="line">                                        assetRoot, </div><div class="line">                                        group,</div><div class="line">                                        String8(), </div><div class="line">                                        mFullAssetPaths, </div><div class="line">                                        <span class="literal">true</span>);</div><div class="line">    <span class="comment">/**********************************/</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">        mGroupEntries.add(group);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>Step 3 收集res/下的资源</em> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">sp&lt;AaptAssets&gt; current = <span class="keyword">this</span>;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;dirCount; i++) &#123;</div><div class="line">      <span class="comment">//资源文件路径</span></div><div class="line">      <span class="keyword">const</span> <span class="keyword">char</span> *res = resDirs[i];</div><div class="line">      <span class="keyword">if</span> (i&gt;<span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">        * 通过链表的形式,将多个res/文件夹连接起来</span></div><div class="line"><span class="comment">        */</span></div><div class="line">        sp&lt;AaptAssets&gt; nextOverlay = <span class="keyword">new</span> AaptAssets();</div><div class="line">        current-&gt;setOverlay(nextOverlay);</div><div class="line">        current = nextOverlay;</div><div class="line">        current-&gt;setFullResPaths(mFullResPaths);</div><div class="line">      &#125;</div><div class="line">      </div><div class="line">      <span class="comment">/**********************************/</span></div><div class="line">      count = current-&gt;slurpResourceTree(bundle, </div><div class="line">                                        String8(res));</div><div class="line">      <span class="comment">/**********************************/</span></div><div class="line">      </div><div class="line">      <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; count &gt; <span class="number">0</span>) &#123;</div><div class="line">          <span class="comment">//过滤某些资源</span></div><div class="line">          count = current-&gt;filter(bundle);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>Step 4 收集直接指定的raw资源</em><br>这部分资源会直接打包进apk文件的根目录，如果想这样做的话，需要在使用aapt时，在命令的最后直接写上文件夹路径</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> arg=<span class="number">0</span>; arg&lt;N; arg++) &#123;</div><div class="line">       <span class="keyword">const</span> <span class="keyword">char</span>* assetDir = bundle-&gt;getFileSpcdecEntry(arg);</div><div class="line">       <span class="function">String8 <span class="title">assetRoot</span><span class="params">(assetDir)</span></span>;</div><div class="line">       </div><div class="line">       <span class="comment">/**********************************/</span></div><div class="line">       count = slurpFullTree(bundle,</div><div class="line">                             assetRoot,</div><div class="line">                             AaptGroupEntry(),</div><div class="line">                             String8(), </div><div class="line">                             mFullAssetPaths);</div><div class="line">       <span class="comment">/**********************************/</span></div><div class="line">       </div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><em>Step 5 校验和过滤</em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">count = validate();</div><div class="line">count = filter(bundle);</div></pre></td></tr></table></figure>
<p>总的来说，slurpFromArgs函数的逻辑非常简单，关键是三个函数调用，<code>addFile()</code>,<code>slurpFullTree()</code>,<code>slurpResourceTree()</code><br>我们逐个来看。</p>
<p><strong>函数 addFile</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 添加文件</span></div><div class="line"><span class="comment"> * @param filePath  资源文件路径</span></div><div class="line"><span class="comment"> * @param entry     资源配置</span></div><div class="line"><span class="comment"> * @param srcDir    资源文件夹路径</span></div><div class="line"><span class="comment"> * @param outGroup  资源文件的group</span></div><div class="line"><span class="comment"> * @param resType   资源类型</span></div><div class="line"><span class="comment"> * @return</span></div><div class="line"><span class="comment"> */</span></div><div class="line">sp&lt;AaptFile&gt; AaptAssets::addFile(</div><div class="line">        <span class="keyword">const</span> String8&amp; filePath,</div><div class="line">        <span class="keyword">const</span> AaptGroupEntry&amp; entry,</div><div class="line">        <span class="keyword">const</span> String8&amp; srcDir,</div><div class="line">        sp&lt;AaptGroup&gt;* outGroup,</div><div class="line">        <span class="keyword">const</span> String8&amp; resType)</div><div class="line">        </div><div class="line">我们用伪代码表示这段逻辑，大概是这样的</div><div class="line"><span class="keyword">for</span>(;;)&#123;</div><div class="line">  AaptDir dir = <span class="keyword">this</span></div><div class="line">  root = filePath的第一级</div><div class="line">  remain = filePath剩余的部分</div><div class="line">  if(remain == '')&#123;//filePath是一个文件</div><div class="line">    AaptGroup group</div><div class="line">    <span class="keyword">if</span>(mFiles.contains(root))&#123;<span class="comment">//已经收集到这个名字的文件</span></div><div class="line">      group = mFiles.get(root)</div><div class="line">    &#125;<span class="keyword">else</span>&#123;<span class="comment">//创建新的group，并添加到mFiles中</span></div><div class="line">      group = <span class="keyword">new</span> AaptGroup(root,filePath)</div><div class="line">      dir.put(root,group)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//创建新的AaptFile</span></div><div class="line">    AaptFile aaptFile = <span class="keyword">new</span> AaptFile(</div><div class="line">                            srcDir+filePath<span class="comment">/*资源文件的全路径*/</span>,</div><div class="line">                            entry,</div><div class="line">                            resType</div><div class="line">                          )</div><div class="line">    group.put(entry,aaptFile)</div><div class="line">    mGroupEntries.add(entry);</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">  &#125;<span class="keyword">else</span>&#123;<span class="comment">//filePath是一个文件夹</span></div><div class="line">    <span class="keyword">if</span>(mDirs.contains(root))&#123;<span class="comment">//当前的mDirs中包含这个文件夹</span></div><div class="line">      dir = mDirs.get(root)</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">      AaptDir subDir = <span class="keyword">new</span> AaptDir()</div><div class="line">      mDirs.put(root,subDir)</div><div class="line">      dir = subDir</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设filePath的值为dir1/dir2/resfile.xml,srcDir的值为/Users/devlop/project/../src/main/。那么，在AaptAssets的mDirs中会建立如下的数据结构:</p>
<p><img src="http://ww3.sinaimg.cn/large/7853084cjw1f7xsz9wmkcj21c40o40x6.jpg" alt=""></p>
<p><strong>函数 slurpResourceTree</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 收集资源</span></div><div class="line"><span class="comment"> * @param bundle    命令参数</span></div><div class="line"><span class="comment"> * @param srcDir    通过-S 参数传入的资源目录路径,可以是相对路径也可以是绝对路径</span></div><div class="line"><span class="comment"> * @return</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">ssize_t</span> AaptAssets::slurpResourceTree(Bundle* bundle,</div><div class="line">                                      <span class="keyword">const</span> String8&amp; srcDir)</div><div class="line">                                      </div><div class="line">我们依然使用伪代码的形式，展示这个函数的逻辑</div><div class="line">List&lt;Dir&gt; resDirs = readdir(srcDir)</div><div class="line"><span class="keyword">for</span>(Dir dir : resDirs)&#123;</div><div class="line">  dirName = dir.getDirName()</div><div class="line">  </div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">  * 根据文件夹的名字获取资源的类型以及资源的配置信息</span></div><div class="line"><span class="comment">  * 注意一点，虽然我们通常在res目录下会创建同类型资源的多个</span></div><div class="line"><span class="comment">  * 文件夹，例如，res/layout,res/layout-xhdpi,res/layout-xxhdpi</span></div><div class="line"><span class="comment">  * 但是，在收集资源的时候，这些文件夹都被认为是layout类型，通</span></div><div class="line"><span class="comment">  * 过 ‘-’分割后，后面的字符串会被处理成资源的配置信息，写入</span></div><div class="line"><span class="comment">  * AaptGroupEntry中。同时，通过'-'连接多个描述信息需要严格按照</span></div><div class="line"><span class="comment">  * 文档中定义的顺序，此处初始化AaptGroupEntry时会对顺序做校验</span></div><div class="line"><span class="comment">  */</span></div><div class="line">  resType = null</div><div class="line">  AaptGroupEntry groupEntry = initAaptGroupWithDirName(resType)</div><div class="line">  </div><div class="line">  AaptDir resDir</div><div class="line">  <span class="keyword">if</span>(mDirs.contains(resType))&#123;</div><div class="line">    resDir = mDirs.get(resType)</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    resDir = <span class="keyword">new</span> AaptDir(resType,resType)</div><div class="line">    mDirs.put(resType,resDir)</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  dir.slurpFullTree(</div><div class="line">                  bundle,         <span class="comment">//命令参数</span></div><div class="line">                  srcDir+dirName, <span class="comment">//资源文件夹的全路径</span></div><div class="line">                  groupEntry,     <span class="comment">//资源配置信息</span></div><div class="line">                  resType,        <span class="comment">//资源类型</span></div><div class="line">                  mFullResPaths   <span class="comment">//和dependency相关的一个参数</span></div><div class="line">                  )</div><div class="line"></div><div class="line">  mGroupEntries.add(groupEntry);</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(!mResDirs.contains(resType))&#123;</div><div class="line">    mResDirs.add(dir)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>函数 slurpFullTree</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 收集某一资源类型下的文件</span></div><div class="line"><span class="comment"> * @param bundle        命令参数</span></div><div class="line"><span class="comment"> * @param srcDir        资源目录的路径,可以是相对路径,也可以是绝对路径</span></div><div class="line"><span class="comment"> * @param kind          资源config</span></div><div class="line"><span class="comment"> * @param resType       资源类型</span></div><div class="line"><span class="comment"> * @param fullResPaths  和dependcy有关的一个参数</span></div><div class="line"><span class="comment"> * @param overwrite     和重叠包相关的一个参数，</span></div><div class="line"><span class="comment">                        是否覆盖已有的文件，默认为false</span></div><div class="line"><span class="comment"> * @return</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">ssize_t</span> AaptDir::slurpFullTree(Bundle* bundle,</div><div class="line">                               <span class="keyword">const</span> String8&amp; srcDir,</div><div class="line">                               <span class="keyword">const</span> AaptGroupEntry&amp; entry,</div><div class="line">                               <span class="keyword">const</span> String8&amp; resType,</div><div class="line">                               sp&lt;FilePathStore&gt;&amp; fullResPaths,</div><div class="line">                               <span class="keyword">const</span> <span class="keyword">bool</span> overwrite)</div><div class="line">                               </div><div class="line">  List&lt;Dir&gt; dirs = readdir(srcDir)</div><div class="line">  <span class="keyword">for</span>(Dir dir : dirs)&#123;</div><div class="line">    dirName = dir.getDirName()</div><div class="line">    <span class="keyword">if</span>(dir == 文件夹)&#123;</div><div class="line">      AaptDir subDir</div><div class="line">      <span class="keyword">if</span>(mDirs.contains(dirName))&#123;<span class="comment">//已经有同名文件夹</span></div><div class="line">        subdir = mDirs.get(dirName)</div><div class="line">      &#125;<span class="keyword">else</span>&#123;<span class="comment">//创建新的AaptDir</span></div><div class="line">        subdir = <span class="keyword">new</span> AaptDir(dirName,dirPath)</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//递归调用</span></div><div class="line">      subdir.slurpFullTree(bundle,</div><div class="line">                          srcDir+dirName,</div><div class="line">                          resType,</div><div class="line">                          fullResPaths,</div><div class="line">                          overwrite)</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (dir == 文件)&#123;</div><div class="line">      fileName = dirName</div><div class="line">      AaptFile aaptFile = <span class="keyword">new</span> AaptFile(</div><div class="line">                                srcDir+fileName,</div><div class="line">                                entry,</div><div class="line">                                resType</div><div class="line">                              )</div><div class="line">      AaptGroup group;</div><div class="line">      <span class="keyword">if</span>(mFiles.contains(fileName))&#123;</div><div class="line">          group = mFile.get(fileName)</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line">          group = <span class="keyword">new</span> AaptGroup(fileName,srcDir+fileName)</div><div class="line">          mFiles.put(fileName,group)</div><div class="line">      &#125;</div><div class="line">      </div><div class="line">      <span class="keyword">if</span>(group.contains(entry) &amp;&amp; overwrite)&#123;</div><div class="line">          mFiles.put(entry,aaptFile)  </div><div class="line">      &#125;</div><div class="line">      </div><div class="line">      <span class="keyword">if</span>(!group.contains(entry))&#123;</div><div class="line">          mFiles.put(entry,aaptFile)</div><div class="line">      &#125;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</div><div class="tags"></div><div class="post-nav"><a href="/插件化之Apk的资源编译/" class="pre">插件化之Apk的资源编译</a><a href="/一次内存泄漏问题的发现与解决过程/" class="next">一次内存泄漏问题的发现与解决过程</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/">Gradle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ReactNative/">ReactNative</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作/">工作</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/插件化/">插件化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机/">计算机</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">chenlong's.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>