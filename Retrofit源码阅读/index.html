<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个Android开发者的成长记录"><title>Retrofit源码阅读 | chenlong's</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?c429fdd6ac00b6f7e59c44c7b27894b8";
var s = document.getElementsByTagName("script")[0]; 
s.parentNode.insertBefore(hm, s);
})();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Retrofit源码阅读</h1><a id="logo" href="/.">chenlong's</a><p class="description">Android开发技术博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 全部</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Retrofit源码阅读</h1><div class="post-meta">May 7, 2017<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><div class="post-content"><h2 id="一、简单使用"><a href="#一、简单使用" class="headerlink" title="一、简单使用"></a>一、简单使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//定义服务接口</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</div><div class="line">  <span class="meta">@GET</span>(<span class="string">"users/&#123;user&#125;/repos"</span>)</div><div class="line">  Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">"user"</span>) String user);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//创建服务实例</span></div><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">    .baseUrl(<span class="string">"https://api.github.com/"</span>)</div><div class="line">    .build();</div><div class="line">GitHubService service = retrofit.create(GitHubService.class);</div><div class="line"></div><div class="line"><span class="comment">//获取Call实例</span></div><div class="line">Call&lt;List&lt;Repo&gt;&gt; reposCall = service.listRepos(<span class="string">"octocat"</span>);</div><div class="line"></div><div class="line"><span class="comment">//同步获取数据</span></div><div class="line">List&lt;Repo&gt; repos = reposCall.execute().body();</div><div class="line"></div><div class="line"><span class="comment">//异步获取数据</span></div><div class="line">resposCall.enqueue(<span class="keyword">new</span> Callback&lt;List&lt;Repo&gt;&gt;()&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call,</span></span></div><div class="line"><span class="function"><span class="params">                         Response&lt;List&lt;Repo&gt;&gt; response)</span> </span>&#123;</div><div class="line">      List&lt;Repo&gt; respos = response.body();</div><div class="line">  &#125;                      </div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="二、源码概览"><a href="#二、源码概览" class="headerlink" title="二、源码概览"></a>二、源码概览</h2><h3 id="0x00-源码结构图"><a href="#0x00-源码结构图" class="headerlink" title="0x00 源码结构图"></a>0x00 源码结构图</h3><p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fgeszkbnfzj317413rted.jpg" alt=""></p>
<h3 id="0x01-流程解析"><a href="#0x01-流程解析" class="headerlink" title="0x01 流程解析"></a>0x01 流程解析</h3><p>以上面的使用方式为例，我们一步一步的查看retrofit的代码的流程，需要注意的几个点如下：</p>
<h4 id="Step-1-创建XXXXService的动态代理"><a href="#Step-1-创建XXXXService的动态代理" class="headerlink" title="Step 1 : 创建XXXXService的动态代理"></a>Step 1 : 创建XXXXService的动态代理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//create 方法是Retrofit唯一暴露给外界的方法，返回了XXXService的动态代理</span></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(</div><div class="line">                service.getClassLoader(), </div><div class="line">                <span class="keyword">new</span> Class&lt;?&gt;[] &#123; service &#125;,</div><div class="line">      <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">          <span class="comment">//平台类型</span></div><div class="line">          <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</div><div class="line">          <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">                              Object proxy,</span></span></div><div class="line"><span class="function"><span class="params">                              Method method,</span></span></div><div class="line"><span class="function"><span class="params">                              @Nullable Object[] args)</span></span></div><div class="line"><span class="function">              <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            <span class="comment">//如果方法来自Object类，则直接调用它</span></div><div class="line">            <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</div><div class="line">              <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//如果是java8中的默认方法，则直接调用它</span></div><div class="line">            <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</div><div class="line">              <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">//从缓存中获取ServiceMethod的实例，或者创建loadServiceMethod实例</span></div><div class="line">            ServiceMethod&lt;Object, Object&gt; serviceMethod = </div><div class="line">               (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</div><div class="line">            </div><div class="line">            <span class="comment">//创建OKHttpCall实例</span></div><div class="line">            OkHttpCall&lt;Object&gt; okHttpCall = </div><div class="line">                <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line"></div><div class="line">            <span class="comment">//根据method定义的返回类型，将okHttpCall转换成需要的返回类型</span></div><div class="line">            <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">          &#125;</div><div class="line">      &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Retrofit重点解决的问题是类型安全，也就是说如何将服务端接口返回的数据直接实例化成javaBean。通常来说，如果要把一个接口的返回数据转换成javaBean，我们会这样做。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line">Gson gson = <span class="keyword">new</span> Gson();</div><div class="line"><span class="comment">//创建请求</span></div><div class="line">Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">      .get()</div><div class="line">      .url(<span class="string">"https://api.github.com/repos/square/retrofit/contributors"</span>)</div><div class="line">      .build();</div><div class="line">okhttp3.Call call = client.newCall(request);</div><div class="line"></div><div class="line"><span class="comment">//同步请求数据</span></div><div class="line">okhttp3.Response response = call.execute();</div><div class="line"></div><div class="line"><span class="comment">//将返回的json字符串转换成javaBean</span></div><div class="line">List&lt;Contributor&gt; contributors = gson.fromJson(</div><div class="line">                response.body().string(),</div><div class="line">                <span class="keyword">new</span> TypeToken&lt;List&lt;Contributor&gt;&gt;()&#123;&#125;.getType());</div><div class="line"></div><div class="line">System.out.println(contributors.size());</div></pre></td></tr></table></figure>
<p>按照上面的写法，有以下几个问题：</p>
<ol>
<li>request的创建并不是类型安全的，依赖于字符串的拼接</li>
<li>response的类型安全强依赖了Gson</li>
<li>需要手动控制回调线程</li>
</ol>
<p>对于如何创建类型安全的Request，Retrofit使用了注解，通过在XXXService的方法上定义注解来实现Request的参数解析，具体支持的注解有三类</p>
<h4 id="1-HTTP方法参数"><a href="#1-HTTP方法参数" class="headerlink" title="1). HTTP方法参数"></a>1). HTTP方法参数</h4><p>7个常用注解，<code>@GET</code>,<code>@POST</code>,<code>@PUT</code>,<code>@DELETE</code>,<code>@OPTION</code>,<code>@PATCH</code>,<code>@HEAD</code>，分别发送对应类型的Http请求。还有一个自定义请求方法的注解，<code>@HTTP</code>,用来指定任意的请求方法</p>
<h4 id="2-URL参数"><a href="#2-URL参数" class="headerlink" title="2). URL参数"></a>2). URL参数</h4><p><code>@Path</code>:确定路径上的参数，例如：@Path(“id”) =&gt; /user/{id}/info<br><code>@Query</code>:确定query参数，例如：@Query(“name”) =&gt; /user/all/info?name=chenlong<br><code>@QueryMap</code>:同上，只是map的key将作为query的key<br><code>@QueryName</code>:确定query的key，但是不赋值。<br><code>@Url</code>:手工拼接url参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>&#123;</div><div class="line">  <span class="meta">@GET</span>(<span class="string">"/user/&#123;id&#125;/info"</span>)</div><div class="line">  <span class="function">Call&lt;UserInfo&gt; <span class="title">getUserInfoById</span><span class="params">(@Path(<span class="string">"id"</span>)</span>String id)</span>;</div><div class="line">  </div><div class="line">  <span class="meta">@GET</span>(<span class="string">"/user/list"</span>)</div><div class="line">  Call&lt;List&lt;UserInfo&gt;&gt; getUserInfoList(<span class="meta">@Query</span>(<span class="string">"offset"</span>) <span class="keyword">int</span> offset,<span class="meta">@Query</span>(<span class="string">"limit"</span>) <span class="keyword">int</span> limit);</div><div class="line">  </div><div class="line">  <span class="meta">@GET</span>(<span class="string">"/user/list"</span>)</div><div class="line">  Call&lt;List&lt;UserInfo&gt;&gt; getUserInfoListByNameAndAge(<span class="meta">@QueryMap</span> Map&lt;String,String&gt; params);</div><div class="line">  </div><div class="line">  <span class="meta">@GET</span></div><div class="line">  <span class="function">Call&lt;UserDetail&gt; <span class="title">getUserDetail</span><span class="params">(@Url String url,@Query(<span class="string">"id"</span>)</span> String id)</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//http://localhost/user/6624/info</span></div><div class="line">helloService.getUserInfoById(<span class="string">"6624"</span>);</div><div class="line"><span class="comment">//http://localhost/user/list?offset=0&amp;limit=10</span></div><div class="line">helloService.getUserInfoList(<span class="number">0</span>,<span class="number">10</span>);</div><div class="line"><span class="comment">//http://localhost/user/list?name=chenlong&amp;age=18</span></div><div class="line">helloService.getUserInfoListByNameAndAge(&#123;</div><div class="line">              name:<span class="string">"chenlong"</span>,</div><div class="line">              age:<span class="number">18</span>&#125;);</div><div class="line"><span class="comment">//http://127.0.0.1:9001/user/detail?id=6624</span></div><div class="line">helloService.getUserDetail(<span class="string">"http://127.0.0.1:9001/user/detail"</span>,<span class="string">"6624"</span>);</div></pre></td></tr></table></figure>
<h4 id="3-Body参数"><a href="#3-Body参数" class="headerlink" title="3). Body参数"></a>3). Body参数</h4><p><code>@FormUrlEncoded</code>[method]:使用表单提交，<br><code>@Field</code>:确定body的参数，例如：@Field(“name”),@Field(“age”) =&gt; name=chenlong&amp;age=10<br><code>@FieldMap</code>:同上<br><code>@Multipart</code>[method]:使用multi-part提交<br><code>@Part</code>:<br><code>@PartMap</code>:<br><code>@Body</code>:使用Convert转化参数</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">```</div><div class="line"></div><div class="line">#### <span class="number">4</span>). Header参数</div><div class="line">`@Headers`[method]:确定header的参数</div><div class="line">`@Header`:动态确定header的参数</div><div class="line">`@HeaderMap`:同上</div></pre></td></tr></table></figure>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### <span class="number">5</span>). 返回值参数</div><div class="line">`@Streaming`: </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">一、ServiceMethod创建</div><div class="line"></div><div class="line">```java</div><div class="line">public ServiceMethod build() &#123;</div><div class="line">    <span class="comment">//根据method的返回值类型，创建callAdapter。对于Android平台，创建的是一个从Call&lt;Object&gt;到Call&lt;Object&gt;的Adapter。</span></div><div class="line">    callAdapter = createCallAdapter();</div><div class="line">    <span class="comment">//获取返回类型，在Android平台上，获取的是Call&lt;T&gt;的实际类型。</span></div><div class="line">    responseType = callAdapter.responseType();</div><div class="line">    <span class="comment">//返回值的Convert</span></div><div class="line">    responseConverter = createResponseConverter();</div><div class="line">    <span class="comment">//解析方法上的注解，此处获取了以下信息</span></div><div class="line">    <span class="comment">//1. HTTP 请求方法</span></div><div class="line">    <span class="comment">//2. url路径</span></div><div class="line">    <span class="comment">//3. url上的路径参数，例如:/user/&#123;id&#125;</span></div><div class="line">    for (Annotation annotation : methodAnnotations) &#123;</div><div class="line">        parseMethodAnnotation(annotation);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//解析方法参数上的注解，并为每一个注解创建一个Handler</span></div><div class="line">    int parameterCount = parameterAnnotationsArray.length;</div><div class="line">    parameterHandlers = new ParameterHandler&lt;?&gt;[parameterCount];</div><div class="line">    for (int p = <span class="number">0</span>; p &lt; parameterCount; p++) &#123;</div><div class="line">      Type parameterType = parameterTypes[p];</div><div class="line">      Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</div><div class="line">      parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有两个地方，我们具体看一下，首先是创建callAdapter的地方。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> CallAdapter&lt;T, R&gt; createCallAdapter() &#123;</div><div class="line">  <span class="comment">//方法的返回值，返回值必须是一个具体的类型，也就是说不能包含泛型，或者通配符</span></div><div class="line">  Type returnType = method.getGenericReturnType();</div><div class="line">  <span class="keyword">if</span> (Utils.hasUnresolvableType(returnType)) &#123;</div><div class="line">    <span class="keyword">throw</span> methodError();</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//返回类型不能是Void</span></div><div class="line">  <span class="keyword">if</span> (returnType == <span class="keyword">void</span>.<span class="keyword">class</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> methodError(<span class="string">"Service methods cannot return void."</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//获取方法注解</span></div><div class="line">  Annotation[] annotations = method.getAnnotations();</div><div class="line">  <span class="comment">//创建</span></div><div class="line">  <span class="keyword">return</span> (CallAdapter&lt;T, R&gt;) retrofit.callAdapter(returnType, annotations);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Retrofit中</span></div><div class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; callAdapter(Type returnType, Annotation[] annotations) &#123;</div><div class="line">  <span class="keyword">int</span> start = adapterFactories.indexOf(skipPast) + <span class="number">1</span>;</div><div class="line">  <span class="comment">//从Retrofit配置的adapterFactory中获取Adapter实例。注意两点：</span></div><div class="line">  <span class="comment">//1. 用户注册的adapterFactory优先于系统的adapterFactory。</span></div><div class="line">  <span class="comment">//2. 用户注册的多个adapterFactory，按照注册的顺序，先返回Adapter实例的会终结后面的adapterFactory</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = start, <span class="keyword">count</span> = adapterFactories.<span class="keyword">size</span>(); i &lt; <span class="keyword">count</span>; i++) &#123;</div><div class="line">    CallAdapter&lt;?, ?&gt; adapter = adapterFactories.get(i).get(returnType, annotations, <span class="keyword">this</span>);</div><div class="line">    <span class="keyword">if</span> (adapter != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> adapter;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于我们没有定制过adapterFactory，因此，此处使用了系统自带的adapterFactory。对于Android平台，Retrofit返回的是如下实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"> <span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</div><div class="line">  <span class="comment">//获取原始类型，如果不是Call类型的返回值直接finish</span></div><div class="line">  <span class="keyword">if</span> (getRawType(returnType) != Call.class) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//获取Call中的泛型类型。</span></div><div class="line">  <span class="keyword">final</span> Type responseType = Utils.getCallResponseType(returnType);</div><div class="line">  </div><div class="line">  <span class="comment">//上面对方法返回值类型的获取已经限定了，这个Adapter只支持返回类型为Call&lt;XXX&gt;的方法。</span></div><div class="line">  <span class="comment">//1. Call&lt;Foo&gt;：responseType为Foo</span></div><div class="line">  <span class="comment">//2. Call&lt;? extends Foo&gt;：responseType为Foo</span></div><div class="line">  <span class="comment">//3. Call&lt;? super Foo&gt;：responseType为Object</span></div><div class="line">  <span class="comment">//实际上就是取上界</span></div><div class="line">  </div><div class="line">  <span class="comment">//返回的依然是一个Call对象，注意CallAdapter的泛型，</span></div><div class="line">  <span class="comment">//对于CallAdapter&lt;S,R&gt;，adapt方法的原型如下：</span></div><div class="line">  <span class="comment">//   R adapt(Call&lt;S&gt; sourceCall);</span></div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> CallAdapter&lt;Object, Call&lt;?&gt;&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Type <span class="title">responseType</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> responseType;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Call&lt;Object&gt; <span class="title">adapt</span><span class="params">(Call&lt;Object&gt; call)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallbackCall&lt;&gt;(callbackExecutor, call);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>针对Android平台返回的ExecutorCallbackCall究竟是一个什么东西呢？实际上只是原始Call对象的包装器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//实现了Call接口</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExecutorCallbackCall</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Call</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">//主线程的Executor</span></div><div class="line">    <span class="keyword">final</span> Executor callbackExecutor;</div><div class="line">    <span class="comment">//代理对象</span></div><div class="line">    <span class="keyword">final</span> Call&lt;T&gt; delegate;</div><div class="line">    ExecutorCallbackCall(Executor callbackExecutor, Call&lt;T&gt; delegate) &#123;</div><div class="line">      <span class="keyword">this</span>.callbackExecutor = callbackExecutor;</div><div class="line">      <span class="keyword">this</span>.delegate = delegate;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个包装器的作用是将Call的回调方法放入Android的UI线程中执行。</p>
<p>CallAdapter实际上是Retrofit设计思想的一大核心，通过适配器模式，可以将Call对象适配成多种形式，例如Rxjava的Observal。</p>
<p>第二个地方，我们来看看参数解析的地方，刚开始使用Retrofit的时候，会觉得通过注解指定参数类型是一件很神奇的事情，但是<br>仔细研读这部分的代码之后会发现，其实也没那么神奇，甚至有点无聊…</p>
<p>Retrofit的注解使用在三个地方，方法，方法的返回值，方法的参数</p>
<ol>
<li>方法上的注解</li>
</ol>
<p>方法上的注解有DELETE，GET，HEAD，PATCH，POST，PUT，OPTIONS，HTTP以及<br>Headers，Multipart，FormUrlEncoder,主要用来标识请求方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//解析方法上的注解</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseMethodAnnotation</span><span class="params">(Annotation annotation)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> GET) &#123;</div><div class="line">    parseHttpMethodAndPath(<span class="string">"GET"</span>, ((GET) annotation).value(), <span class="keyword">false</span>);</div><div class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> POST)&#123;</div><div class="line">    parseHttpMethodAndPath(<span class="string">"POST"</span>, ((POST) annotation).value(), <span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line">  ....</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> httpMethod   请求方法</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> value        注解的值</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> hasbody      是否有body</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseHttpMethodAndPath</span><span class="params">(String httpMethod, String value, <span class="keyword">boolean</span> hasBody)</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>.httpMethod = httpMethod;</div><div class="line">  <span class="keyword">this</span>.hasBody = hasBody;</div><div class="line">  <span class="keyword">this</span>.relativeUrl = value;</div><div class="line">  <span class="comment">//解析路径上的参数，使用正则："&#123;([a-zA-Z][a-zA-Z0-9_-]*)&#125;"匹配形如：</span></div><div class="line">  <span class="comment">//user/&#123;id&#125;/detail的路径参数</span></div><div class="line">  <span class="keyword">this</span>.relativeUrlParamNames = parsePathParameters(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>参数上的注解</li>
</ol>
<p>参数上的注解比较多，我们简单的看一个，对@Path的解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Path) &#123;</div><div class="line">    <span class="comment">//Path注解不可以写在@Query后面</span></div><div class="line">    <span class="keyword">if</span> (gotQuery) &#123;</div><div class="line">      <span class="keyword">throw</span> parameterError(p, <span class="string">"A @Path parameter must not come after a @Query."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//Path注解不可以和@Url一起使用</span></div><div class="line">    <span class="keyword">if</span> (gotUrl) &#123;</div><div class="line">      <span class="keyword">throw</span> parameterError(p, <span class="string">"@Path parameters may not be used with @Url."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//必须先指定相对路径</span></div><div class="line">    <span class="keyword">if</span> (relativeUrl == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> parameterError(p, <span class="string">"@Path can only be used with relative url on @%s"</span>, httpMethod);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//标识已经获取Path参数</span></div><div class="line">    gotPath = <span class="keyword">true</span>;</div><div class="line">    </div><div class="line">    Path path = (Path) annotation;</div><div class="line">    String name = path.value();</div><div class="line">    <span class="comment">//校验path的值，正则，"[a-zA-Z][a-zA-Z0-9_-]*"，并且path的值在路径已经指定</span></div><div class="line">    validatePathName(p, name);</div><div class="line">    <span class="comment">//默认的转换器是直接toString()，可以自定义实现。这个convert应用于如下注解：</span></div><div class="line">    <span class="comment">//@Field,@FieldMap,@Header,@HeaderMap,@Path,@Query,@QueryMap</span></div><div class="line">    Converter&lt;?, String&gt; converter = retrofit.stringConverter(type, annotations);</div><div class="line">    <span class="comment">//返回Path注解的handler。</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ParameterHandler.Path&lt;&gt;(name, converter, path.encoded());</div><div class="line">    </div><div class="line">&#125; </div><div class="line"><span class="comment">//Path注解的Handler</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Path</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ParameterHandler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Converter&lt;T, String&gt; valueConverter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> encoded;</div><div class="line"></div><div class="line">    Path(String name, Converter&lt;T, String&gt; valueConverter, <span class="keyword">boolean</span> encoded) &#123;</div><div class="line">      <span class="keyword">this</span>.name = checkNotNull(name, <span class="string">"name == null"</span>);</div><div class="line">      <span class="keyword">this</span>.valueConverter = valueConverter;</div><div class="line">      <span class="keyword">this</span>.encoded = encoded;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestBuilder builder, @Nullable T value)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">      <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">            <span class="string">"Path parameter \""</span> + name + <span class="string">"\" value must not be null."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//向RequestBuilder传入参数</span></div><div class="line">      builder.addPathParam(name, valueConverter.convert(value), encoded);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对参数的注解解析稍微复杂点，主要是为每一种类型的注解实现一个Handler，所有注解的Handler在ParameterHandler中定义，原型如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterHandler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestBuilder builder, @Nullable T value)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>方法返回值上的注解</li>
</ol>
<p>在创建CallAdapter的时候使用，默认的实现里没有使用方法返回值上的注解。</p>
<p>二、OKHttpCall的执行过程</p>
<p>在上一步，我们创建了ServiceMethod对象，这个对象描述了我们定义的XXXService中的一个方法。但是，这个方法并不能发起网络请求，如果需要发起<br>网络请求，我们需要借助OKHttpCall来实现。</p>
<p>OkHttpCall包含以下的属性<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//一次网络请求的实际实现</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpCall</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Call</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">  <span class="comment">//serviceMethod实例</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ServiceMethod&lt;T, ?&gt; serviceMethod;</div><div class="line">  <span class="comment">//实际请求参数</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> Object[] args;</div><div class="line">  <span class="comment">//原始的OKHttpClient的Call</span></div><div class="line">  <span class="keyword">private</span> <span class="meta">@Nullable</span> okhttp3.Call rawCall;</div><div class="line">  </div><div class="line">  <span class="comment">//异常</span></div><div class="line">  <span class="keyword">private</span> <span class="meta">@Nullable</span> Throwable creationFailure; </div><div class="line">  <span class="comment">//取消标志位</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> canceled;</div><div class="line">  <span class="comment">//执行标志位</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> executed;</div><div class="line">  </div><div class="line">  ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在默认的Retrofit实现中，XXXService的方法都返回一个Call对象，并没有实际的执行，当我们需要获取返回值的时候，才会调用Call的同步或者异步方法来执行请求。</p>
<p>同步方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Response&lt;T&gt; <span class="title">execute</span><span class="params">()</span></span>&#123;</div><div class="line">  okhttp3.Call call = rawCall;</div><div class="line">  <span class="keyword">if</span> (call == <span class="keyword">null</span>) call = rawCall = createRawCall();</div><div class="line">  <span class="keyword">return</span> parseResponse(call.execute());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>异步方法：<br>略。核心都是先createRawCall()，然后parseResponse();</p>
<p>Call的两个核心方法如下：</p>
<ol>
<li><p>创建Request</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> okhttp3.<span class="function">Call <span class="title">createRawCall</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">//创建Request的实例</span></div><div class="line">    Request request = serviceMethod.toRequest(args);</div><div class="line">    <span class="comment">//创建OKHttpClient的实例</span></div><div class="line">    okhttp3.Call call = serviceMethod.callFactory.newCall(request);</div><div class="line">    <span class="keyword">return</span> call;</div><div class="line">&#125;</div><div class="line"><span class="comment">//serviceMethod中的方法</span></div><div class="line"><span class="function">Request <span class="title">toRequest</span><span class="params">(@Nullable Object... args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//根据method的注解解析结果创建RequestBuilder</span></div><div class="line">    RequestBuilder requestBuilder = <span class="keyword">new</span> RequestBuilder(httpMethod, baseUrl, relativeUrl, headers,</div><div class="line">        contentType, hasBody, isFormEncoded, isMultipart);</div><div class="line"></div><div class="line">    <span class="comment">//将实际的参数填入RequestBuilder</span></div><div class="line">    ParameterHandler&lt;Object&gt;[] handlers = (ParameterHandler&lt;Object&gt;[]) parameterHandlers;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; argumentCount; p++) &#123;</div><div class="line">      <span class="comment">//前面根据参数的注解和参数的类型创建的Handler依次调用，将实际参数填入RequestBuilder</span></div><div class="line">      handlers[p].apply(requestBuilder, args[p]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//创建Request实例</span></div><div class="line">    <span class="keyword">return</span> requestBuilder.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>解析返回值</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"> <span class="function">Response&lt;T&gt; <span class="title">parseResponse</span><span class="params">(okhttp3.Response rawResponse)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    ResponseBody rawBody = rawResponse.body();</div><div class="line"></div><div class="line">    <span class="comment">// Remove the body's source (the only stateful object) so we can pass the response along.</span></div><div class="line">    rawResponse = rawResponse.newBuilder()</div><div class="line">        .body(<span class="keyword">new</span> NoContentResponseBody(rawBody.contentType(), rawBody.contentLength()))</div><div class="line">        .build();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> code = rawResponse.code();</div><div class="line">    <span class="comment">//失败</span></div><div class="line">    <span class="keyword">if</span> (code &lt; <span class="number">200</span> || code &gt;= <span class="number">300</span>) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// Buffer the entire body to avoid future I/O.</span></div><div class="line">        ResponseBody bufferedBody = Utils.buffer(rawBody);</div><div class="line">        <span class="keyword">return</span> Response.error(bufferedBody, rawResponse);</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        rawBody.close();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="comment">//成功，不需要处理返回值</span></div><div class="line">    <span class="keyword">if</span> (code == <span class="number">204</span> || code == <span class="number">205</span>) &#123;</div><div class="line">      rawBody.close();</div><div class="line">      <span class="keyword">return</span> Response.success(<span class="keyword">null</span>, rawResponse);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//对原始Response做一次包装，用来catch异常</span></div><div class="line">    ExceptionCatchingRequestBody catchingBody = <span class="keyword">new</span> ExceptionCatchingRequestBody(rawBody);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">//解析返回数据</span></div><div class="line">      T body = serviceMethod.toResponse(catchingBody);</div><div class="line">      <span class="keyword">return</span> Response.success(body, rawResponse);</div><div class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">      <span class="comment">// If the underlying source threw an exception, propagate that rather than indicating it was</span></div><div class="line">      <span class="comment">// a runtime exception.</span></div><div class="line">      catchingBody.throwIfCaught();</div><div class="line">      <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//上面的代码主要是针对返回的code做一次解析，区分成功和失败，其次是异常捕获，核心的返回值解析部分依然是在ServiceMethod中。</span></div><div class="line"></div><div class="line"><span class="comment">//将返回值交给responseConvert转换成body之后返回</span></div><div class="line"><span class="function">R <span class="title">toResponse</span><span class="params">(ResponseBody body)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="keyword">return</span> responseConverter.convert(body);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//对于ResponseConvert，我们用的最多的是json转对象，我们来看一下常用的GsonResponseBodyConverter</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  JsonReader jsonReader = gson.newJsonReader(value.charStream());</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">return</span> adapter.read(jsonReader);</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    value.close();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="三、感想感悟"><a href="#三、感想感悟" class="headerlink" title="三、感想感悟"></a>三、感想感悟</h2><p>阅读完Retrofit的代码，值得关注的地方有以下几点</p>
<ol>
<li>使用动态代理来统一所有的方法调用</li>
<li>将整个网络请求分割成了三个阶段，请求参数解析，请求执行，解析返回值，每个阶段由单独的对象来处理。<br>请求参数解析：ServiceMethod<br>请求执行:OKHttpCall<br>参数解析：Convert</li>
<li>针对Call的定制化需求，设计了CallAdapter来满足不同的需求</li>
</ol>
</div><div class="tags"></div><div class="post-nav"><a href="/WindowManager学习/" class="pre">WindowManager学习</a><a href="/泛型与反射学习笔记/" class="next">泛型与反射学习笔记</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/">Gradle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ReactNative/">ReactNative</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作/">工作</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/插件化/">插件化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机/">计算机</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">chenlong's.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>