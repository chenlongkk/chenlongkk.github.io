<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个Android开发者的成长记录"><title>Zygote进程的启动过程 | chenlong's</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?c429fdd6ac00b6f7e59c44c7b27894b8";
var s = document.getElementsByTagName("script")[0]; 
s.parentNode.insertBefore(hm, s);
})();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Zygote进程的启动过程</h1><a id="logo" href="/.">chenlong's</a><p class="description">Android开发技术博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 全部</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Zygote进程的启动过程</h1><div class="post-meta">Sep 21, 2016<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><div class="post-content"><h1 id="两个个问题"><a href="#两个个问题" class="headerlink" title="两个个问题"></a>两个个问题</h1><p>应用的main函数在哪里？</p>
<p>android:process=”:remote”为什么可以创建一个进程？</p>
<h1 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h1><h2 id="1-Android平台上Kernel的启动过程"><a href="#1-Android平台上Kernel的启动过程" class="headerlink" title="1. Android平台上Kernel的启动过程"></a>1. Android平台上Kernel的启动过程</h2><p>开机<br>执行bootloader<br>装载用户程序，uboot/fastboot，并运行<br>装载Linux内核，开始内核初始化的过程</p>
<h2 id="2-进程"><a href="#2-进程" class="headerlink" title="2. 进程"></a>2. 进程</h2><p>一个执行中的程序的实例，系统中的每个程序都是运行在某个进程的上下文中的，上下文主要包括以下内容：</p>
<ol>
<li>存储器中的程序的代码和数据</li>
<li>栈</li>
<li>通用目的寄存器的内容</li>
<li>程序计数器</li>
<li>环境变量</li>
<li>打开文件描述符<br>….</li>
</ol>
<h2 id="3-0号进程和1号进程"><a href="#3-0号进程和1号进程" class="headerlink" title="3. 0号进程和1号进程"></a>3. 0号进程和1号进程</h2><p><strong>1. idle进程</strong><br>idle进程由系统自动创建, 运行在内核态 idle进程其pid=0，其前身是系统创建的第一个进程，也是唯一一个没有通过fork或者kernel_thread产生的进程。完成加载系统后，演变为进程调度、交换<br><strong>2. init进程</strong><br>init进程由idle通过kernel_thread创建，在内核空间完成初始化后, 加载init程序, 并最终用户空间 由0进程创建，完成系统的初始化. 是系统中所有其它用户进程的祖先进程 Linux中的所有进程都是有init进程创建并运行的。首先Linux内核启动，然后在用户空间中启动init进程，再启动其他系统进程。在系统启动完成完成后，init将变为守护进程监视系统其他进程。</p>
<h2 id="4-fork-函数"><a href="#4-fork-函数" class="headerlink" title="4. fork()函数"></a>4. fork()函数</h2><p>程序包含位于内存的多个组成部分，执行程序的过程将根据需要来访问这些内容，包括文本段（text segment）、数据段（data segments）、栈（stack）和堆（heap）。文本段中存放CPU所执行的命令，数据段存放进程操作的所有数据变量，栈存放自动变量和函数数据，堆存放动态内存分配情况数据。当进程被创建时，子进程收到父进程的数据副本，包括数据空间、堆、栈和进程描述符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Fork() causes creation of a new process.  The new process (child process) is an exact copy of the calling process</div><div class="line">     (parent process) except <span class="keyword">for</span> the following:</div><div class="line">          </div><div class="line">          The child process has a unique process ID.</div><div class="line">          </div><div class="line">          The child process has a different parent process ID (i.e., the process ID of the parent process).</div><div class="line">          </div><div class="line">          The child process has its own copy of the parent<span class="string">'s descriptors.  These descriptors reference the same underlying objects, so that, for instance, file pointers in file objects are shared between the child and the parent, so that an lseek(2) on a descriptor in the child process can affect a subsequent read or write by the parent.  This descriptor copying is also used by the shell to establish standard input and output for newly created processes as well as to set up pipes.</span></div><div class="line"><span class="string">          </span></div><div class="line"><span class="string">          The child processes resource utilizations are set to 0; see setrlimit(2).</span></div><div class="line"><span class="string">RETURN VALUES</span></div><div class="line"><span class="string">     Upon successful completion, fork() returns a value of 0 to the child process and returns the process ID of the child</span></div><div class="line"><span class="string">     process to the parent process.  Otherwise, a value of -1 is returned to the parent process, no child process is cre-</span></div><div class="line"><span class="string">     ated, and the global variable errno is set to indicate the error.</span></div></pre></td></tr></table></figure>
<h2 id="IPC与Binder驱动"><a href="#IPC与Binder驱动" class="headerlink" title="IPC与Binder驱动"></a>IPC与Binder驱动</h2><ol>
<li>直观来说，Binder是Android中的一个类，它继承了IBinder接口</li>
<li>从IPC角度来说，Binder是Android中的一种跨进程通信方式，Binder还可以理解为一种虚拟的物理设备，它的设备驱动是/dev/binder，该通信方式在linux中没有</li>
<li>从Android Framework角度来说，Binder是ServiceManager连接各种Manager（ActivityManager、WindowManager，etc）和相应ManagerService的桥梁</li>
<li>从Android应用层来说，Binder是客户端和服务端进行通信的媒介，当你bindService的时候，服务端会返回一个包含了服务端业务调用的Binder对象，通过这个Binder对象，客户端就可以获取服务端提供的服务或者数据，这里的服务包括普通服务和基于AIDL的服务</li>
</ol>
<h1 id="Framework的启动过程"><a href="#Framework的启动过程" class="headerlink" title="Framework的启动过程"></a>Framework的启动过程</h1><h2 id="Zygote与应用进程之间的关系"><a href="#Zygote与应用进程之间的关系" class="headerlink" title="Zygote与应用进程之间的关系"></a>Zygote与应用进程之间的关系</h2><p><img src="http://ww3.sinaimg.cn/large/65e4f1e6jw1fajdnx0f84j20li0dqt9x.jpg" alt=""></p>
<h2 id="Step-1-init进程读取init-rc文件"><a href="#Step-1-init进程读取init-rc文件" class="headerlink" title="Step 1: init进程读取init.rc文件"></a>Step 1: init进程读取init.rc文件</h2><p><img src="http://ww2.sinaimg.cn/large/65e4f1e6jw1fajdqf4y29j20uk09kabl.jpg" alt=""></p>
<h2 id="Step-2-app-process的main函数"><a href="#Step-2-app-process的main函数" class="headerlink" title="Step 2: app_process的main函数"></a>Step 2: app_process的main函数</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">base/cmd/app_process/app_mian.cpp</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span>&#123;</div><div class="line">      ...</div><div class="line">      <span class="comment">//解析参数</span></div><div class="line">      zygote = <span class="literal">true</span></div><div class="line">      nicename = <span class="string">"zygote64"</span><span class="comment">//64位，32位下为"zyogte"</span></div><div class="line">      增加了一个参数<span class="string">"--abi-list"</span></div><div class="line">      ...</div><div class="line">      <span class="keyword">if</span>(zygote)&#123;</div><div class="line">        runtime-&gt;start(<span class="string">"com.android.internal.os.ZygoteInit"</span>);</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line">        runtime-&gt;start(<span class="string">"com.android.internal.os.RuntimeInit"</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="Step-3-AndroidRuntime-gt-start-方法"><a href="#Step-3-AndroidRuntime-gt-start-方法" class="headerlink" title="Step 3: AndroidRuntime-&gt;start()方法"></a>Step 3: AndroidRuntime-&gt;start()方法</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">base/core/jni/android/AndroidRuntime.cc</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">start</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* className,<span class="keyword">const</span> Vector&lt;String8&gt;&amp; options,<span class="keyword">bool</span> zygote)</span></span>&#123;</div><div class="line">      </div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">        打开libart.so 库，</span></div><div class="line"><span class="comment">        初始化以下三个方法：</span></div><div class="line"><span class="comment">        1. JNI_GetDefaultJavaVMInitArgs</span></div><div class="line"><span class="comment">        2. JNI_CreateJavaVM</span></div><div class="line"><span class="comment">        3. JNI_GetCreatedJavaVMs</span></div><div class="line"><span class="comment">      */</span></div><div class="line">      JniInvocation jniInvocation;</div><div class="line">      jniInvocation.Init(<span class="literal">NULL</span>);</div><div class="line">      </div><div class="line">      </div><div class="line">      ...</div><div class="line">      <span class="comment">//启动虚拟机</span></div><div class="line">      <span class="comment">//JavaVM是每一个进程一个，JniEnv每个线程一个</span></div><div class="line">      startVm(&amp;mJavaVm,env,zygote);</div><div class="line">      ...</div><div class="line">      <span class="comment">//执行entryClass的main函数</span></div><div class="line">      env-&gt;CallStaticVoidMethod(startClass,startMeth,strArray);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="Step-4-startVm-方法"><a href="#Step-4-startVm-方法" class="headerlink" title="Step 4:startVm()方法"></a>Step 4:startVm()方法</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">-&gt;art/runtime/runtime.cc</div><div class="line">  </div><div class="line">  <span class="keyword">bool</span> Runtime::Create(<span class="keyword">const</span> RuntimeOptions&amp; options,<span class="keyword">bool</span> ignore_unrecongized)&#123;</div><div class="line">      <span class="comment">//创建实例，注意此处runtime实例是一个单例</span></div><div class="line">      instance_ = <span class="keyword">new</span> Runtime;</div><div class="line">      <span class="comment">//执行初始化方法</span></div><div class="line">      instance_-&gt;Init(options,ignore_unrecognized)</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * 初始化runtime</span></div><div class="line"><span class="comment">   **/</span></div><div class="line">  <span class="keyword">bool</span> Runtime:Init(<span class="keyword">const</span> RuntimeOptions&amp; options,<span class="keyword">bool</span> ignore_unrecongized)&#123;</div><div class="line">      ...</div><div class="line">      is_zygote_ = ....</div><div class="line">      java_vm_ = <span class="keyword">new</span> JavaVMExt(<span class="keyword">this</span>,runtime_options);</div><div class="line">      ...</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * 启动虚拟机</span></div><div class="line"><span class="comment">   **/</span></div><div class="line">  <span class="keyword">bool</span> Runtime::Start()&#123;</div><div class="line">      ...</div><div class="line">      system_class_loader_ = CreateSystemClassLoader(<span class="keyword">this</span>)</div><div class="line">      ...</div><div class="line">      <span class="keyword">if</span>(is_zygote_)&#123;<span class="comment">//初始化zygote进程</span></div><div class="line">        InitZygote();</div><div class="line">      &#125;<span class="keyword">else</span>&#123;<span class="comment">//从zygote进程fork子进程</span></div><div class="line">        DidForkFromZygote(...)</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="Step-5-Zygote的main方法"><a href="#Step-5-Zygote的main方法" class="headerlink" title="Step 5: Zygote的main方法"></a>Step 5: Zygote的main方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 启动Zygote</span></div><div class="line"><span class="comment"> * 注意，此处依然运行在app_process的进程中</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">  </div><div class="line">  <span class="keyword">try</span>&#123;</div><div class="line">      <span class="comment">//注册socket服务端</span></div><div class="line">      registerZygoteSocket(socketName);</div><div class="line">      <span class="comment">//预加载一些类和资源</span></div><div class="line">      preload();</div><div class="line">      <span class="comment">//对zygote进程做GC</span></div><div class="line">      gcAndFinalize();</div><div class="line">      <span class="keyword">if</span>(startSystemServer)&#123;</div><div class="line">        <span class="comment">//启动SystemServer</span></div><div class="line">        startSystemServer(abiList,sockerName);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//死循环</span></div><div class="line">      runSelectLoop(abiList);</div><div class="line">      <span class="comment">//关闭socket服务端</span></div><div class="line">      closeServerSocket();</div><div class="line">  &#125;<span class="keyword">catch</span>(MethodAndArgsCaller caller)&#123;</div><div class="line">      caller.run();</div><div class="line">  &#125;<span class="keyword">catch</span>(RuntimeException e)&#123;</div><div class="line">      closeServerSocket();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="registerZygoteSocket"><a href="#registerZygoteSocket" class="headerlink" title="registerZygoteSocket"></a>registerZygoteSocket</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 启动socket服务端</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerZygoteSocket</span><span class="params">(String socketName)</span></span>&#123;</div><div class="line">  <span class="keyword">if</span>(sServerSocker == <span class="keyword">null</span>)&#123;</div><div class="line">    <span class="comment">//获取"ANDROID_SOCKET_zygote"对应的文件描述符</span></div><div class="line">    <span class="keyword">int</span> fileDesc = System.getenv(<span class="string">"ANDROID_SOCKET_zygote"</span>);</div><div class="line">    FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</div><div class="line">    fd.setInt$(fileDesc);</div><div class="line">    sServerSocker = <span class="keyword">new</span> LocalServerScoket(fd);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="preload"><a href="#preload" class="headerlink" title="preload"></a>preload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 预加载系统类和资源</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="comment">//读取/system/etc/preloaded-classes文件，</span></div><div class="line">  <span class="comment">//文件每一行都是类名，使用当前的虚拟机实例加载它们</span></div><div class="line">  preloadClasses();</div><div class="line">  <span class="comment">//加载R.array.preloaded_drawables中定义的drawable</span></div><div class="line">  <span class="comment">//加载R.array.preloaded_color_state_lists中定义的colorStateList</span></div><div class="line">  preloadResource();</div><div class="line">  <span class="comment">//加载OpenGL库</span></div><div class="line">  preloadOpenGL();</div><div class="line">  <span class="comment">//加载"android"，"compiler_rt","jnigraphics"</span></div><div class="line">  preloadSharedLibraries();</div><div class="line">  <span class="comment">//加载国际化处理的一些东西</span></div><div class="line">  preloadTextResources();</div><div class="line">  <span class="comment">//初始化webview，应该是加载浏览器内核</span></div><div class="line">  WebViewFactory.prepareWebViewInZygote();</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="runSelectLoop"><a href="#runSelectLoop" class="headerlink" title="runSelectLoop"></a>runSelectLoop</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 接收socket消息</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span></span>&#123;</div><div class="line">    List&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">        Os.poll(pollFds,-<span class="number">1</span>);</div><div class="line">        ZygoteConnection newPeer = acceptCommandPeer(abiList)</div><div class="line">        peers.add(newPeer);</div><div class="line">        newPeer.runOnce();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="runOnce"><a href="#runOnce" class="headerlink" title="runOnce()"></a>runOnce()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">-&gt;framworks/base/core/java/com/android/internal/os/ZygoteConnection.java</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runOnce</span><span class="params">()</span></span>&#123;</div><div class="line">      pid = Zygote.forkAndSpecialize(...)</div><div class="line">      <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</div><div class="line">        closeSocket();</div><div class="line">        ZygoteInit.closeServerSocket();</div><div class="line">        RuntimeInit.zygoteInit(...);</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line">        handleParentProc(...);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="启动SystemServer"><a href="#启动SystemServer" class="headerlink" title="启动SystemServer"></a>启动SystemServer</h2><h3 id="startSystemServer"><a href="#startSystemServer" class="headerlink" title="startSystemServer"></a>startSystemServer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">  * 启动SystemServer</span></div><div class="line"><span class="comment">  **/</span></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList,String socketName)</span></span>&#123;</div><div class="line">     String args[] = &#123;</div><div class="line">       ...</div><div class="line">       <span class="string">"--nice-name=system_server"</span></div><div class="line">       <span class="string">"com.android.server.SystemServer"</span></div><div class="line">     &#125;</div><div class="line">     ZygoteConnection.Arguments parsedArgs = <span class="keyword">new</span> Arguments(args);</div><div class="line">     <span class="keyword">int</span> pid = Zygote.forkSystemServer(...parsedArgs);</div><div class="line">     </div><div class="line">     <span class="comment">//fork()函数调用一次，返回两次，在父进程返回子进程pid</span></div><div class="line">     <span class="comment">//在子进程返回0</span></div><div class="line">     <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</div><div class="line">       handleSystemServerProcess(...)</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="handleSystemServerProcess"><a href="#handleSystemServerProcess" class="headerlink" title="handleSystemServerProcess"></a>handleSystemServerProcess</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 处理system_server 进程</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleSystemServerProcess</span><span class="params">(Zygoteconnection.Arguments parsedArgs)</span></span>&#123;</div><div class="line">    <span class="comment">//由于是从zygote中fork出来的，携带了zygote的socket服务端，</span></div><div class="line">    <span class="comment">//先关掉</span></div><div class="line">    closeServerSocket();</div><div class="line">    <span class="comment">//获取SystemServer的classpath</span></div><div class="line">    String systemServerClassPath </div><div class="line">            = OS.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</div><div class="line">    <span class="comment">//执行dexopt</span></div><div class="line">    performSystemServerDexOpt(systemServerClassPath);</div><div class="line">    </div><div class="line">    <span class="comment">//设置当前线程的上下文classloader，增加"SYSTEMSERVERCLASSPATH"</span></div><div class="line">    <span class="comment">//对应的jar包</span></div><div class="line">    ClassLoader cl= <span class="keyword">new</span> PathClassLoader(</div><div class="line">                      systemServerClassPath,</div><div class="line">                      ClassLoader.getSystemClassLoader());</div><div class="line">    Thread.currentThread().setContextClassLoader(cl);</div><div class="line">    </div><div class="line">    <span class="comment">//初始化com.android.server.SystemServer类</span></div><div class="line">    RuntimeInit.zygoteInit(parsedArgs.targerSdkVersion,</div><div class="line">                           parsedArgs.remainingArgs,cl);</div><div class="line">                           </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SystemServer的main方法"><a href="#SystemServer的main方法" class="headerlink" title="SystemServer的main方法"></a>SystemServer的main方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">main</span><span class="params">(String[] argvs)</span></span>&#123;</div><div class="line">  <span class="keyword">new</span> SystemServer().run();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">  ...</div><div class="line">  System.loadLibrary(<span class="string">"android_servers"</span>);</div><div class="line">  ...</div><div class="line">  createSystemContext();</div><div class="line">  mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</div><div class="line">  LocalServices.addService(SystemServiceManager.class,mSystemServiceManager);</div><div class="line">  </div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * 启动系统服务</span></div><div class="line"><span class="comment">   * 1. Installer</span></div><div class="line"><span class="comment">   * 2. ActivityManagerService</span></div><div class="line"><span class="comment">   * 3. PowerManagerService</span></div><div class="line"><span class="comment">   * 4. PackageManagerService</span></div><div class="line"><span class="comment">   * 5. WindowManagerService</span></div><div class="line"><span class="comment">   * 6. LauncherAppService</span></div><div class="line"><span class="comment">   * ...</span></div><div class="line"><span class="comment">   **/</span></div><div class="line">  startBootstrapServices();</div><div class="line">  startCoreServices();</div><div class="line">  startOtherServices();</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><div class="tags"></div><div class="post-nav"><a href="/插件化之Activity生命周期的hook/" class="pre">插件化之Activity生命周期的hook</a><a href="/插件化之Apk的资源编译/" class="next">插件化之Apk的资源编译</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/">Gradle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ReactNative/">ReactNative</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作/">工作</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/插件化/">插件化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机/">计算机</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">chenlong's.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>